name: Build Ninja for Android (All Architectures)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: Setup NDK r29
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r29
        add-to-path: false

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [arm64-v8a, armeabi-v7a, x86_64, x86]

    steps:
    - name: Checkout Ninja Source
      uses: actions/checkout@v4

    - name: Setup NDK r29 (from cache)
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r29
        add-to-path: true

    - name: Install Host Ninja
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build
        ninja --version

    - name: Verify Patches
      run: |
        echo "=== Checking ninja_export.cc ==="
        ls -la src/ninja_export.cc
        echo ""
        echo "=== Checking subprocess-posix.cc patches ==="
        grep -n "__ANDROID__" src/subprocess-posix.cc | head -5
        echo ""
        echo "=== Checking configure.py has ninja_export ==="
        grep -n "ninja_export" configure.py

    - name: Configure Build
      run: |
        case "${{ matrix.arch }}" in
          arm64-v8a) 
            CLANG_PREFIX="aarch64-linux-android"
            ARCH_FLAGS="-march=armv8-a"
            ;;
          armeabi-v7a) 
            CLANG_PREFIX="armv7a-linux-androideabi"
            ARCH_FLAGS="-march=armv7-a -mfloat-abi=softfp -mfpu=neon"
            ;;
          x86_64) 
            CLANG_PREFIX="x86_64-linux-android"
            ARCH_FLAGS=""
            ;;
          x86) 
            CLANG_PREFIX="i686-linux-android"
            ARCH_FLAGS="-march=i686"
            ;;
        esac
        
        echo "CLANG_PREFIX=$CLANG_PREFIX" >> $GITHUB_ENV
        echo "ARCH_FLAGS=$ARCH_FLAGS" >> $GITHUB_ENV

    - name: Build Ninja as Shared Library
      run: |
        export CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ env.CLANG_PREFIX }}21-clang"
        export CXX="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ env.CLANG_PREFIX }}21-clang++"
        export CXXFLAGS="-D__ANDROID__ -Os -fPIC -ffunction-sections -fdata-sections ${{ env.ARCH_FLAGS }}"
        export LDFLAGS="-Wl,--gc-sections -Wl,--strip-all -Wl,-z,max-page-size=16384"
        
        echo "Configuring Ninja for ${{ matrix.arch }}..."
        python3 configure.py
        
        echo "Building with host ninja..."
        ninja -v
        
        echo ""
        echo "libninja.a size:"
        ls -lh build/libninja.a
        echo ""
        
        # Build as shared library WITHOUT --gc-sections to keep all code
        echo "Creating libninja.so from static library..."
        
        $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ env.CLANG_PREFIX }}21-clang++ \
          -shared -o libninja.so \
          -Wl,--whole-archive build/libninja.a -Wl,--no-whole-archive \
          -fPIC \
          -Wl,-z,max-page-size=16384 \
          -ldl -llog -latomic
        
        echo "✓ Created libninja.so (before strip)"
        ls -lh libninja.so
        
        $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded libninja.so
        
        echo "✓ Created libninja.so (after strip)"
        ls -lh libninja.so
        file libninja.so
        
        # Verify exported symbols
        echo ""
        echo "Key exported symbols:"
        nm -D libninja.so | grep -E "ninja_main|ninja_set_command_executor|real_main"
        echo ""
        echo "Total exported symbols:"
        nm -D libninja.so | wc -l

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ninja-android-${{ matrix.arch }}
        path: libninja.so
        retention-days: 30

    - name: Build Summary
      run: |
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "  Ninja Android - ${{ matrix.arch }}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Architecture: ${{ matrix.arch }}"
        echo "Min API:      21 (Android 5.0+)"
        echo "Size:         $(ls -lh libninja.so | awk '{print $5}')"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"