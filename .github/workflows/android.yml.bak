name: Build Ninja for Android (All Architectures)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [arm64-v8a, armeabi-v7a, x86_64, x86]

    steps:
    - name: Checkout Ninja Source
      uses: actions/checkout@v4

    - name: Setup NDK r29
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r29
        add-to-path: true

    - name: Verify Patches
      run: |
        echo "=== Checking ninja_export.cc ==="
        ls -la src/ninja_export.cc
        echo ""
        echo "=== Checking subprocess-posix.cc patches ==="
        grep -n "__ANDROID__" src/subprocess-posix.cc | head -5
        echo ""
        echo "=== Checking configure.py has ninja_export ==="
        grep -n "ninja_export" configure.py

    - name: Configure Build
      run: |
        case "${{ matrix.arch }}" in
          arm64-v8a) 
            CLANG_PREFIX="aarch64-linux-android"
            ARCH_FLAGS="-march=armv8-a"
            ;;
          armeabi-v7a) 
            CLANG_PREFIX="armv7a-linux-androideabi"
            ARCH_FLAGS="-march=armv7-a -mfloat-abi=softfp -mfpu=neon"
            ;;
          x86_64) 
            CLANG_PREFIX="x86_64-linux-android"
            ARCH_FLAGS=""
            ;;
          x86) 
            CLANG_PREFIX="i686-linux-android"
            ARCH_FLAGS="-march=i686"
            ;;
        esac
        
        echo "CLANG_PREFIX=$CLANG_PREFIX" >> $GITHUB_ENV
        echo "ARCH_FLAGS=$ARCH_FLAGS" >> $GITHUB_ENV

    - name: Build Ninja
      run: |
        export CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ env.CLANG_PREFIX }}21-clang"
        export CXX="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ env.CLANG_PREFIX }}21-clang++"
        export CXXFLAGS="-D__ANDROID__ -Os -ffunction-sections -fdata-sections -fvisibility=hidden ${{ env.ARCH_FLAGS }}"
        export LDFLAGS="-Wl,--gc-sections -Wl,--strip-all -Wl,-z,max-page-size=16384"
        
        echo "Building Ninja for ${{ matrix.arch }}..."
        python3 configure.py --bootstrap
        
        if [ ! -f ninja ]; then
          echo "ERROR: Build failed - ninja binary not found"
          exit 1
        fi
        
        echo "✓ Build successful"
        ls -lh ninja
        file ninja
        
        # Verify exported symbols
        nm -D ninja | grep ninja_main || echo "WARNING: ninja_main not found"
        nm -D ninja | grep ninja_set_command_executor || echo "WARNING: ninja_set_command_executor not found"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ninja-android-${{ matrix.arch }}
        path: ninja
        retention-days: 30

    - name: Build Summary
      run: |
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "  Ninja Android - ${{ matrix.arch }}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Architecture: ${{ matrix.arch }}"
        echo "Min API:      21 (Android 5.0+)"
        echo "Size:         $(ls -lh ninja | awk '{print $5}')"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"